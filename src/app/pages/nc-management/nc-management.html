<section class="nc-management">
  <header class="page-header">
    <div>
      <p class="eyebrow">Exception review</p>
      <h1>NC management</h1>
      <p class="subtitle">
        Review negative responses across audits and track remediation workflow.
      </p>
    </div>
    <div class="header-actions">
      <label class="filter">
        Severity
        <select>
          <option>All severities</option>
          <option>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </label>
      <label class="filter">
        Status
        <select>
          <option>All statuses</option>
          <option>Open</option>
          <option>In review</option>
          <option>Resolved</option>
        </select>
      </label>
      <label class="filter">
        Time range
        <select>
          <option>Last 30 days</option>
          <option>Last 7 days</option>
          <option>Quarter to date</option>
          <option>Year to date</option>
        </select>
      </label>
    </div>
  </header>

  <section class="panel wide">
    <div class="panel-header">
      <div class="section-title">
        <h2>Flagged questions</h2>
        <span class="count">{{ ncRecords().length }} flagged</span>
      </div>
      <button class="ghost small" type="button" (click)="toggleFlagged()">
        {{ showFlagged ? 'Collapse' : 'Expand' }}
      </button>
    </div>
    <div class="nc-grid" *ngIf="showFlagged && ncRecords().length">
      <article class="nc-card" *ngFor="let record of ncRecords()">
        <div class="nc-card-header">
          <div>
            <p class="audit-label">Audit</p>
            <p class="code">
              {{ record.auditCode }} · {{ record.auditType }} · {{ record.auditSubtype }}
            </p>
            <p class="meta">
              {{ formatDate(record.startDate) }} → {{ formatDate(record.endDate) }}
            </p>
          </div>
          <span class="status-pill medium">Submitted</span>
        </div>
        <div class="nc-body">
          <div class="question-block">
            <span>Question</span>
            <strong>{{ record.question }}</strong>
          </div>
          <div class="meta-row">
            <div class="meta-block">
              <span>Response</span>
              <strong>{{ record.response }}</strong>
            </div>
            <div class="meta-block">
              <span>Assigned NC</span>
              <select
                class="assignee-select"
                [ngModelOptions]="{ standalone: true }"
                name="assigned-nc-{{ record.answerId }}"
                [ngModel]="record.assignedNc || ''"
                (ngModelChange)="updateAssignedNc(record, $event)"
              >
                <option value="">Select department</option>
                <option *ngFor="let department of departments" [ngValue]="department">
                  {{ department }}
                </option>
              </select>
            </div>
            <div class="meta-block">
              <span>Assigned user</span>
              <select
                class="assignee-select"
                [ngModelOptions]="{ standalone: true }"
                name="assignee-{{ record.answerId }}"
                [ngModel]="getAssignedUserId(record) || ''"
                (ngModelChange)="assignUser(record, $event)"
                [disabled]="(!!getAssignedUserId(record) && auth.role() !== 'Manager') || (record.status || '').toLowerCase() === 'rework'"
              >
                <option value="">Select user</option>
                <option
                  *ngIf="getAssignedUserId(record) && !hasAssignedUserOption(record)"
                  [ngValue]="getAssignedUserId(record)"
                >
                  {{ getAssignedUserLabel(record) }}
                </option>
                <option
                  *ngFor="let user of usersForDepartment(record.assignedNc)"
                  [ngValue]="user.id"
                >
                  {{ userLabel(user) }} ({{ user.email }})
                </option>
              </select>
            </div>
            <div class="meta-block">
              <span>Auditor</span>
              <strong>{{ record.auditorName || '—' }}</strong>
            </div>
          </div>
          <div class="note-block">
            <span>Auditor note</span>
            <p>{{ record.note || '—' }}</p>
          </div>
        </div>
        <div class="nc-actions">
          <button
            class="primary small"
            type="button"
            (click)="openRecord(record)"
            [disabled]="!canPerformNc(record)"
          >
            Perform NC
          </button>
        </div>
      </article>
    </div>
  </section>

  <section class="panel wide">
    <div class="panel-header">
      <div class="section-title">
        <h2>Pending review</h2>
        <span class="count">{{ pendingReviewRecords().length }} total</span>
      </div>
      <button class="ghost small" type="button" (click)="togglePendingReview()">
        {{ showPendingReview ? 'Collapse' : 'Expand' }}
      </button>
    </div>
    <div class="audit-grid" *ngIf="showPendingReview && pendingReviewRecords().length">
      <article class="audit-card" *ngFor="let record of pendingReviewRecords()">
        <div class="audit-card-header">
          <div>
            <p class="audit-label">Audit</p>
            <p class="code">
              {{ record.auditCode }} · {{ record.auditType }} · {{ record.auditSubtype }}
            </p>
          </div>
          <div class="card-actions">
            <button class="ghost small" type="button" (click)="openReview(record)">
              View
            </button>
            <button class="ghost small" type="button" (click)="requestRework(record)">
              Request rework
            </button>
            <button class="primary small" type="button" (click)="approveNc(record)">
              Close NC
            </button>
          </div>
        </div>
        <div class="audit-meta">
          <div class="meta-block">
            <span>Question</span>
            <strong>{{ record.question }}</strong>
          </div>
          <div class="meta-block">
            <span>Response</span>
            <strong>{{ record.response }}</strong>
          </div>
          <div class="meta-block">
            <span>Assigned NC</span>
            <strong>{{ record.assignedNc || '—' }}</strong>
          </div>
        </div>
        <div class="audit-footer">
          <div class="meta-block">
            <span>Root cause</span>
            <strong>{{ record.rootCause || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>Containment</span>
            <strong>{{ record.containmentAction || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>Corrective</span>
            <strong>{{ record.correctiveAction || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>Preventive</span>
            <strong>{{ record.preventiveAction || '—' }}</strong>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="showPendingReview && !pendingReviewRecords().length">
      No resolutions pending review.
    </div>
  </section>

  <div class="drawer-backdrop" *ngIf="activeRecord">
    <aside class="drawer">
      <header class="drawer-header">
        <div>
          <h2>Perform NC</h2>
          <p class="subtitle">
            {{ activeRecord.auditCode }} · {{ activeRecord.auditType }} ·
            {{ activeRecord.auditSubtype }} ·
            {{ formatDate(activeRecord.startDate) }} → {{ formatDate(activeRecord.endDate) }}
          </p>
        </div>
        <button class="ghost small" type="button" (click)="closeRecord()">Close</button>
      </header>
      <section class="drawer-content">
        <div class="detail-card">
          <div class="detail-row">
            <span>Question</span>
            <strong>{{ activeRecord.question }}</strong>
          </div>
          <div class="detail-grid">
            <div>
              <span>Response</span>
              <strong>{{ activeRecord.response }}</strong>
            </div>
            <div>
              <span>Assigned NC</span>
              <strong>{{ activeRecord.assignedNc || '—' }}</strong>
            </div>
            <div>
              <span>Auditor</span>
              <strong>{{ activeRecord.auditorName || '—' }}</strong>
            </div>
            <div>
              <span>Submitted</span>
            <strong>{{ activeRecord.submittedAt | date:'medium' }}</strong>
            </div>
          </div>
          <div class="detail-row">
            <span>Auditor note</span>
            <strong>{{ activeRecord.note || '—' }}</strong>
          </div>
        </div>
        <div class="response-card">
          <h3>NC response</h3>
          <div class="response-grid">
            <label>
              Root Cause
              <textarea rows="2" [(ngModel)]="ncResponse.rootCause"></textarea>
            </label>
            <label>
              Containment Action
              <textarea rows="2" [(ngModel)]="ncResponse.containmentAction"></textarea>
            </label>
            <label>
              Corrective Action
              <textarea rows="2" [(ngModel)]="ncResponse.correctiveAction"></textarea>
            </label>
            <label>
              Preventive Action
              <textarea rows="2" [(ngModel)]="ncResponse.preventiveAction"></textarea>
            </label>
          </div>
          <div class="response-actions">
            <label class="ghost small file-trigger">
              Attach evidence
              <input type="file" (change)="onEvidenceSelected($event)" />
            </label>
            <span class="evidence-name" *ngIf="ncResponse.evidenceFile">
              {{ ncResponse.evidenceFile }}
            </span>
            <div class="response-buttons">
              <button class="ghost" type="button" (click)="saveNc()">Save</button>
              <button class="primary" type="button" (click)="submitNc()">Submit</button>
              <button class="ghost" type="button" (click)="closeRecord()">Cancel</button>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <div class="drawer-backdrop" *ngIf="viewRecord">
    <aside class="drawer">
      <header class="drawer-header">
        <div>
          <h2>Pending review</h2>
          <p class="subtitle">
            {{ viewRecord.auditCode }} · {{ viewRecord.auditType }} ·
            {{ viewRecord.auditSubtype }} ·
            {{ formatDate(viewRecord.startDate) }} → {{ formatDate(viewRecord.endDate) }}
          </p>
        </div>
        <button class="ghost small" type="button" (click)="closeReview()">Close</button>
      </header>
      <section class="drawer-content">
        <div class="detail-card">
          <div class="detail-row">
            <span>Question</span>
            <strong>{{ viewRecord.question }}</strong>
          </div>
          <div class="detail-grid">
            <div>
              <span>Response</span>
              <strong>{{ viewRecord.response }}</strong>
            </div>
            <div>
              <span>Assigned NC</span>
              <strong>{{ viewRecord.assignedNc || '—' }}</strong>
            </div>
            <div>
              <span>Auditor</span>
              <strong>{{ viewRecord.auditorName || '—' }}</strong>
            </div>
            <div>
              <span>Submitted</span>
              <strong>{{ viewRecord.submittedAt | date:'medium' }}</strong>
            </div>
          </div>
          <div class="detail-row">
            <span>Auditor note</span>
            <strong>{{ viewRecord.note || '—' }}</strong>
          </div>
        </div>
        <div class="detail-card">
          <div class="detail-grid stacked">
            <div>
              <span>Root cause</span>
              <strong>{{ viewRecord.rootCause || '—' }}</strong>
            </div>
            <div>
              <span>Containment</span>
              <strong>{{ viewRecord.containmentAction || '—' }}</strong>
            </div>
            <div>
              <span>Corrective</span>
              <strong>{{ viewRecord.correctiveAction || '—' }}</strong>
            </div>
            <div>
              <span>Preventive</span>
              <strong>{{ viewRecord.preventiveAction || '—' }}</strong>
            </div>
            <div>
              <span>Evidence</span>
              <strong>{{ viewRecord.evidenceName || '—' }}</strong>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>
</section>
