<section class="nc-management">
  <header class="page-header">
    <div>
      <p class="eyebrow">Exception review</p>
      <h1>NC management</h1>
      <p class="subtitle">
        Review negative responses across audits and track remediation workflow.
      </p>
    </div>
    <div class="header-actions">
      <label class="filter">
        Severity
        <select>
          <option>All severities</option>
          <option>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </label>
      <label class="filter">
        Status
        <select>
          <option>All statuses</option>
          <option>Open</option>
          <option>In review</option>
          <option>Resolved</option>
        </select>
      </label>
      <label class="filter">
        Assigned NC
        <select [(ngModel)]="assignedFilter" [ngModelOptions]="{ standalone: true }">
          <option value="">All departments</option>
          <option *ngFor="let department of departments" [value]="department">
            {{ department }}
          </option>
        </select>
      </label>
      <label class="filter">
        Time range
        <select>
          <option>Last 30 days</option>
          <option>Last 7 days</option>
          <option>Quarter to date</option>
          <option>Year to date</option>
        </select>
      </label>
    </div>
  </header>

  <section class="panel wide">
    <div class="panel-header">
      <div class="section-title">
        <h2>NC overview</h2>
        <span class="count" *ngIf="activeTab === 'flagged'">
          {{ ncRecords().length }} flagged
        </span>
        <span class="count" *ngIf="activeTab === 'pending'">
          {{ pendingReviewRecords().length }} pending
        </span>
        <span class="count" *ngIf="activeTab === 'closed'">
          {{ closedRecords().length }} closed
        </span>
      </div>
      <div class="tab-switch">
        <button
          type="button"
          [class.active]="activeTab === 'flagged'"
          (click)="setTab('flagged')"
        >
          Flagged questions
        </button>
        <button
          type="button"
          [class.active]="activeTab === 'pending'"
          (click)="setTab('pending')"
        >
          Pending review
        </button>
        <button
          type="button"
          [class.active]="activeTab === 'closed'"
          (click)="setTab('closed')"
        >
          Closed NCs
        </button>
      </div>
    </div>
    <div class="nc-grid" *ngIf="activeTab === 'flagged' && ncRecords().length">
      <article class="nc-card compact" *ngFor="let record of ncRecords()">
        <div class="nc-row">
          <div class="nc-main">
            <div class="nc-title">
              <span class="code">{{ record.auditCode }}</span>
              <span class="divider">·</span>
              <span>{{ record.auditType }}</span>
              <span class="divider">·</span>
              <span>{{ record.auditSubtype || '—' }}</span>
              <span class="divider">·</span>
              <span>{{ record.question }}</span>
            </div>
            <div class="nc-sub">
              <span>{{ formatDate(record.startDate) }} → {{ formatDate(record.endDate) }}</span>
              <span class="divider">·</span>
              <span>Response: {{ record.response }}</span>
              <span class="divider">·</span>
              <span>Auditor: {{ record.auditorName || '—' }}</span>
            </div>
          </div>
          <div class="nc-inline">
            <span class="status-pill medium">Submitted</span>
            <select
              class="assignee-select"
              [ngModelOptions]="{ standalone: true }"
              name="assigned-nc-{{ record.answerId }}"
              [ngModel]="pendingAssignedNc[record.answerId] ?? record.assignedNc || ''"
              (ngModelChange)="updateAssignedNc(record, $event)"
              [disabled]="!!getAssignedUserId(record)"
            >
              <option value="">Assign NC</option>
              <option *ngFor="let department of departments" [ngValue]="department">
                {{ department }}
              </option>
            </select>
            <button
              class="ghost small"
              type="button"
              (click)="confirmAssignedNc(record)"
              [disabled]="!isAssignedNcPending(record) || !!getAssignedUserId(record)"
            >
              Assign
            </button>
            <select
              class="assignee-select"
              [ngModelOptions]="{ standalone: true }"
              name="assignee-{{ record.answerId }}"
              [ngModel]="getAssignedUserId(record) || ''"
              (ngModelChange)="assignUser(record, $event)"
              [disabled]="!canAssignUser(record) || !!getAssignedUserId(record)"
            >
              <option value="">Assigned user</option>
              <option
                *ngIf="getAssignedUserId(record) && !hasAssignedUserOption(record)"
                [ngValue]="getAssignedUserId(record)"
              >
                {{ getAssignedUserLabel(record) }}
              </option>
              <option
                *ngFor="let user of usersForDepartment(record.assignedNc)"
                [ngValue]="user.id"
              >
                {{ userLabel(user) }} ({{ user.email }})
              </option>
            </select>
            <button
              class="primary small"
              type="button"
              (click)="openRecord(record)"
              [disabled]="!canPerformNc(record)"
            >
              Perform NC
            </button>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="activeTab === 'flagged' && !ncRecords().length">
      No flagged questions right now.
    </div>
    <div class="audit-grid" *ngIf="activeTab === 'pending' && pendingReviewRecords().length">
      <article class="audit-card compact" *ngFor="let record of pendingReviewRecords()">
        <div class="nc-row">
          <div class="nc-main">
            <div class="nc-title">
              <span class="code">{{ record.auditCode }}</span>
              <span class="divider">·</span>
              <span>{{ record.auditType }}</span>
              <span class="divider">·</span>
              <span>{{ record.auditSubtype || '—' }}</span>
              <span class="divider">·</span>
              <span>{{ record.question }}</span>
            </div>
            <div class="nc-sub">
              <span>Response: {{ record.response }}</span>
              <span class="divider">·</span>
              <span>Assigned NC: {{ record.assignedNc || '—' }}</span>
            </div>
          </div>
          <div class="nc-inline">
            <button class="ghost small" type="button" (click)="openReview(record)">
              View
            </button>
            <button class="primary small" type="button" (click)="approveNc(record)">
              Close NC
            </button>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="activeTab === 'pending' && !pendingReviewRecords().length">
      No resolutions pending review.
    </div>
    <div class="audit-grid" *ngIf="activeTab === 'closed' && closedRecords().length">
      <article class="audit-card compact" *ngFor="let record of closedRecords()">
        <div class="nc-row">
          <div class="nc-main">
            <div class="nc-title">
              <span class="code">{{ record.auditCode }}</span>
              <span class="divider">·</span>
              <span>{{ record.auditType }}</span>
              <span class="divider">·</span>
              <span>{{ record.auditSubtype || '—' }}</span>
              <span class="divider">·</span>
              <span>{{ record.question }}</span>
            </div>
            <div class="nc-sub">
              <span>Response: {{ record.response }}</span>
              <span class="divider">·</span>
              <span>Assigned NC: {{ record.assignedNc || '—' }}</span>
              <span class="divider">·</span>
              <span>Status: {{ record.status || 'Closed' }}</span>
            </div>
          </div>
          <div class="nc-inline">
            <button class="ghost small" type="button" (click)="openClosed(record)">
              View
            </button>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="activeTab === 'closed' && !closedRecords().length">
      No closed NCs yet.
    </div>
  </section>

  <div class="drawer-backdrop" *ngIf="activeRecord">
    <aside class="drawer">
      <header class="drawer-header">
        <div>
          <h2>Perform NC</h2>
          <p class="subtitle">
            {{ activeRecord.auditCode }} · {{ activeRecord.auditType }} ·
            {{ activeRecord.auditSubtype }} ·
            {{ formatDate(activeRecord.startDate) }} → {{ formatDate(activeRecord.endDate) }}
          </p>
        </div>
        <button class="ghost small" type="button" (click)="closeRecord()">Close</button>
      </header>
      <section class="drawer-content">
        <div class="detail-card">
          <div class="detail-row">
            <span>Question</span>
            <strong>{{ activeRecord.question }}</strong>
          </div>
          <div class="detail-grid">
            <div>
              <span>Response</span>
              <strong>{{ activeRecord.response }}</strong>
            </div>
            <div>
              <span>Assigned NC</span>
              <strong>{{ activeRecord.assignedNc || '—' }}</strong>
            </div>
            <div>
              <span>Auditor</span>
              <strong>{{ activeRecord.auditorName || '—' }}</strong>
            </div>
            <div>
              <span>Submitted</span>
            <strong>{{ activeRecord.submittedAt | date:'medium' }}</strong>
            </div>
          </div>
          <div class="detail-row">
            <span>Auditor note</span>
            <strong>{{ activeRecord.note || '—' }}</strong>
          </div>
        </div>
        <div class="response-card">
          <h3>NC response</h3>
          <div class="response-grid">
            <label>
              Root Cause
              <textarea rows="2" [(ngModel)]="ncResponse.rootCause"></textarea>
            </label>
            <label>
              Containment Action
              <textarea rows="2" [(ngModel)]="ncResponse.containmentAction"></textarea>
            </label>
            <label>
              Corrective Action
              <textarea rows="2" [(ngModel)]="ncResponse.correctiveAction"></textarea>
            </label>
            <label>
              Preventive Action
              <textarea rows="2" [(ngModel)]="ncResponse.preventiveAction"></textarea>
            </label>
          </div>
          <div class="response-actions">
            <label class="ghost small file-trigger">
              Attach evidence
              <input type="file" (change)="onEvidenceSelected($event)" />
            </label>
            <span class="evidence-name" *ngIf="ncResponse.evidenceFile">
              {{ ncResponse.evidenceFile }}
            </span>
            <div class="response-buttons">
              <button class="ghost" type="button" (click)="saveNc()">Save</button>
              <button class="primary" type="button" (click)="submitNc()">Submit</button>
              <button class="ghost" type="button" (click)="closeRecord()">Cancel</button>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <div class="drawer-backdrop" *ngIf="viewRecord">
    <aside class="drawer">
      <header class="drawer-header">
        <div>
          <h2>{{ viewRecord?.status?.toLowerCase() === 'closed' ? 'Closed NC' : 'Pending review' }}</h2>
          <p class="subtitle">
            {{ viewRecord.auditCode }} · {{ viewRecord.auditType }} ·
            {{ viewRecord.auditSubtype }} ·
            {{ formatDate(viewRecord.startDate) }} → {{ formatDate(viewRecord.endDate) }}
          </p>
        </div>
        <button class="ghost small" type="button" (click)="closeReview()">Close</button>
      </header>
      <section class="drawer-content">
        <div class="detail-card">
          <div class="detail-row">
            <span>Question</span>
            <strong>{{ viewRecord.question }}</strong>
          </div>
          <div class="detail-grid">
            <div>
              <span>Response</span>
              <strong>{{ viewRecord.response }}</strong>
            </div>
            <div>
              <span>Assigned NC</span>
              <strong>{{ viewRecord.assignedNc || '—' }}</strong>
            </div>
            <div>
              <span>Auditor</span>
              <strong>{{ viewRecord.auditorName || '—' }}</strong>
            </div>
            <div>
              <span>Submitted</span>
              <strong>{{ viewRecord.submittedAt | date:'medium' }}</strong>
            </div>
          </div>
          <div class="detail-row">
            <span>Auditor note</span>
            <strong>{{ viewRecord.note || '—' }}</strong>
          </div>
        </div>
        <div class="detail-card">
          <div class="detail-grid stacked">
            <div>
              <span>Root cause</span>
              <strong>{{ viewRecord.rootCause || '—' }}</strong>
            </div>
            <div>
              <span>Containment</span>
              <strong>{{ viewRecord.containmentAction || '—' }}</strong>
            </div>
            <div>
              <span>Corrective</span>
              <strong>{{ viewRecord.correctiveAction || '—' }}</strong>
            </div>
            <div>
              <span>Preventive</span>
              <strong>{{ viewRecord.preventiveAction || '—' }}</strong>
            </div>
            <div>
              <span>Evidence</span>
              <strong>{{ viewRecord.evidenceName || '—' }}</strong>
            </div>
            <div>
              <span>Status</span>
              <strong>{{ viewRecord.status || '—' }}</strong>
            </div>
            <div>
              <span>Assigned user</span>
              <strong>{{ viewRecord.assignedUserName || viewRecord.assignedUserEmail || '—' }}</strong>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>
</section>
