<section class="audit-manage">
  <header class="page-header">
    <div>
      <p class="eyebrow">Audit oversight</p>
      <h1>Audit manage</h1>
      <p class="subtitle">Track and organize all created audits.</p>
    </div>
  </header>

  <section class="panel wide">
    <div class="panel-header">
      <div class="section-title">
        <h2>Completed audits</h2>
        <span class="count">{{ completedAudits.length }} total</span>
      </div>
      <button class="ghost small" type="button" (click)="toggleCompleted()">
        {{ showCompleted ? 'Collapse' : 'Expand' }}
      </button>
    </div>
    <div class="audit-grid" *ngIf="showCompleted && completedAudits.length">
      <article class="audit-card" *ngFor="let audit of completedAudits">
        <div class="audit-card-header">
          <div>
            <p class="audit-label">Audit code</p>
            <p class="code">{{ audit.code }}</p>
          </div>
          <div class="card-actions">
            <button class="ghost small" type="button" (click)="openEdit(audit)" disabled>
              Edit
            </button>
            <button class="ghost small" type="button" (click)="openView(audit)">View</button>
            <button
              class="ghost small danger"
              type="button"
              (click)="deleteAudit(audit)"
              *ngIf="auth.role() === 'Manager'"
              [disabled]="completionMap[audit.code] === 'Completed'"
            >
              Delete
            </button>
          </div>
        </div>
        <div class="audit-meta">
          <div class="meta-block">
            <span>Dates</span>
            <strong>{{ formatDate(audit.startDate) }} → {{ formatDate(audit.endDate) }}</strong>
          </div>
          <div class="meta-block">
            <span>Audit type</span>
            <strong>{{ audit.auditType }}</strong>
            <em>{{ audit.auditSubtype || '—' }}</em>
          </div>
          <div class="meta-block">
            <span>Auditor</span>
            <strong>{{ audit.auditorName || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>NC count</span>
            <strong>{{ getAuditProgress(audit).nc }}</strong>
          </div>
        </div>
        <div class="audit-footer">
          <div class="meta-block">
            <span>Department</span>
            <strong>{{ audit.department || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>Location</span>
            <strong>{{ audit.country || '—' }} · {{ audit.locationCity || '—' }}</strong>
            <em>{{ audit.site || '—' }} · {{ audit.region || '—' }}</em>
          </div>
          <div class="meta-block note-cell">
            <span>Note</span>
            <p class="note-text">{{ audit.auditNote || 'No note provided' }}</p>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="!completedAudits.length">
      No completed audits yet.
    </div>
  </section>

  <section class="panel wide">
    <div class="panel-header">
      <div class="section-title">
        <h2>Created audits</h2>
        <span class="count">{{ createdAudits.length }} total</span>
      </div>
      <button class="ghost small" type="button" (click)="toggleCreated()">
        {{ showCreated ? 'Collapse' : 'Expand' }}
      </button>
    </div>
    <div class="audit-grid" *ngIf="showCreated && createdAudits.length">
      <article class="audit-card" *ngFor="let audit of createdAudits">
        <div class="audit-card-header">
          <div>
            <p class="audit-label">Audit code</p>
            <p class="code">{{ audit.code }}</p>
          </div>
          <div class="card-actions">
            <button
              class="ghost small"
              type="button"
              (click)="openEdit(audit)"
              [disabled]="completionMap[audit.code] === 'Completed'"
            >
              Edit
            </button>
            <button class="ghost small" type="button" (click)="openView(audit)">View</button>
          </div>
        </div>
        <div class="audit-meta">
          <div class="meta-block">
            <span>Dates</span>
            <strong>{{ formatDate(audit.startDate) }} → {{ formatDate(audit.endDate) }}</strong>
          </div>
          <div class="meta-block">
            <span>Audit type</span>
            <strong>{{ audit.auditType }}</strong>
            <em>{{ audit.auditSubtype || '—' }}</em>
          </div>
          <div class="meta-block">
            <span>Auditor</span>
            <strong>{{ audit.auditorName || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>NC count</span>
            <strong>{{ getAuditProgress(audit).nc }}</strong>
          </div>
        </div>
        <div class="audit-footer">
          <div class="meta-block">
            <span>Department</span>
            <strong>{{ audit.department || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>Location</span>
            <strong>{{ audit.country || '—' }} · {{ audit.locationCity || '—' }}</strong>
            <em>{{ audit.site || '—' }} · {{ audit.region || '—' }}</em>
          </div>
          <div class="meta-block note-cell">
            <span>Note</span>
            <p class="note-text">{{ audit.auditNote || 'No note provided' }}</p>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="!createdAudits.length">
      No created audits waiting to start.
    </div>
  </section>

  <section class="panel wide">
    <div class="panel-header">
      <div class="section-title">
        <h2>In progress audits</h2>
        <span class="count">{{ inProgressAudits.length }} total</span>
      </div>
      <button class="ghost small" type="button" (click)="toggleInProgress()">
        {{ showInProgress ? 'Collapse' : 'Expand' }}
      </button>
    </div>
    <div class="audit-grid" *ngIf="showInProgress && inProgressAudits.length">
      <article class="audit-card" *ngFor="let audit of inProgressAudits">
        <div class="audit-card-header">
          <div>
            <p class="audit-label">Audit code</p>
            <p class="code">{{ audit.code }}</p>
          </div>
          <div class="card-actions">
            <button
              class="ghost small"
              type="button"
              (click)="openEdit(audit)"
              [disabled]="completionMap[audit.code] === 'Completed'"
            >
              Edit
            </button>
            <button class="ghost small" type="button" (click)="openView(audit)">View</button>
          </div>
        </div>
        <div class="audit-meta">
          <div class="meta-block">
            <span>Dates</span>
            <strong>{{ formatDate(audit.startDate) }} → {{ formatDate(audit.endDate) }}</strong>
          </div>
          <div class="meta-block">
            <span>Audit type</span>
            <strong>{{ audit.auditType }}</strong>
            <em>{{ audit.auditSubtype || '—' }}</em>
          </div>
          <div class="meta-block">
            <span>Auditor</span>
            <strong>{{ audit.auditorName || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>NC count</span>
            <strong>{{ getAuditProgress(audit).nc }}</strong>
          </div>
        </div>
        <div class="audit-footer">
          <div class="meta-block">
            <span>Department</span>
            <strong>{{ audit.department || '—' }}</strong>
          </div>
          <div class="meta-block">
            <span>Location</span>
            <strong>{{ audit.country || '—' }} · {{ audit.locationCity || '—' }}</strong>
            <em>{{ audit.site || '—' }} · {{ audit.region || '—' }}</em>
          </div>
          <div class="meta-block note-cell">
            <span>Note</span>
            <p class="note-text">{{ audit.auditNote || 'No note provided' }}</p>
          </div>
        </div>
      </article>
    </div>
    <div class="empty" *ngIf="!inProgressAudits.length">
      No in-progress audits right now.
    </div>
  </section>

  <div class="modal-backdrop" *ngIf="activeAudit">
    <form class="modal" #editFormRef="ngForm" (ngSubmit)="saveEdit(editFormRef)">
      <header>
        <h2>Edit audit</h2>
        <button class="ghost small" type="button" (click)="closeEdit(editFormRef)">Close</button>
      </header>
      <p class="modal-subtitle">Audit type and subtype are read-only.</p>
      <div class="form-grid">
        <label>
          Start date
          <input type="date" name="startDate" [(ngModel)]="editForm.startDate" required />
        </label>
        <label>
          End date
          <input type="date" name="endDate" [(ngModel)]="editForm.endDate" required />
        </label>
        <label>
          Audit type
          <input type="text" name="auditType" [(ngModel)]="editForm.auditType" disabled />
        </label>
        <label>
          Audit subtype
          <input type="text" name="auditSubtype" [(ngModel)]="editForm.auditSubtype" disabled />
        </label>
        <label>
          Response type
          <select name="responseType" [(ngModel)]="editForm.responseType">
            <option value="">Select response type</option>
            <option *ngFor="let response of responses" [value]="response">
              {{ response }}
            </option>
          </select>
        </label>
        <label>
          Auditor
          <select name="auditorName" [(ngModel)]="editForm.auditorName">
            <option value="">Select auditor</option>
            <option
              *ngFor="let auditor of auditors"
              [value]="auditor.first_name + ' ' + auditor.last_name"
            >
              {{ auditor.first_name }} {{ auditor.last_name }}
            </option>
          </select>
        </label>
        <label>
          Department
          <select name="department" [(ngModel)]="editForm.department">
            <option value="">Select department</option>
            <option *ngFor="let department of departments" [value]="department">
              {{ department }}
            </option>
          </select>
        </label>
        <label>
          Country
          <select name="country" [(ngModel)]="editForm.country">
            <option value="">Select country</option>
            <option value="India">India</option>
            <option value="USA">USA</option>
            <option value="Canada">Canada</option>
          </select>
        </label>
        <label>
          City
          <select name="locationCity" [(ngModel)]="editForm.locationCity">
            <option value="">Select city</option>
            <option *ngFor="let city of cities" [value]="city">{{ city }}</option>
          </select>
        </label>
        <label>
          Site
          <select name="site" [(ngModel)]="editForm.site">
            <option value="">Select site</option>
            <option *ngFor="let site of sites" [value]="site">{{ site }}</option>
          </select>
        </label>
        <label>
          Region
          <select name="region" [(ngModel)]="editForm.region">
            <option value="">Select region</option>
            <option *ngFor="let region of regions" [value]="region">{{ region }}</option>
          </select>
        </label>
        <label class="full">
          Audit note
          <textarea
            rows="4"
            maxlength="1000"
            name="auditNote"
            [(ngModel)]="editForm.auditNote"
          ></textarea>
        </label>
      </div>
      <div class="modal-actions">
        <button class="ghost" type="button" (click)="closeEdit(editFormRef)">Cancel</button>
        <button class="primary" type="submit">Save changes</button>
      </div>
    </form>
  </div>

  <div class="modal-backdrop" *ngIf="viewAudit">
    <div class="modal">
      <header>
        <h2>Submitted responses</h2>
      </header>
      <p class="modal-subtitle">
        {{ viewAudit.auditType }} · {{ viewAudit.auditSubtype || '—' }} ·
        {{ formatDate(viewAudit.startDate) }} → {{ formatDate(viewAudit.endDate) }}
      </p>
      <div class="view-list" *ngIf="viewResponses.length; else emptyResponses">
        <article class="view-card" *ngFor="let response of viewResponses">
          <div class="view-row">
            <span>Question</span>
            <strong>{{ response.question }}</strong>
          </div>
          <div class="view-grid">
            <div>
              <span>Response</span>
              <strong>{{ response.response }}</strong>
            </div>
            <div>
              <span>Assigned NC</span>
              <strong>{{ response.assignedNc || '—' }}</strong>
            </div>
            <div>
              <span>Auditor</span>
              <strong>{{ response.auditorName || '—' }}</strong>
            </div>
            <div>
              <span>Submitted</span>
              <strong>{{ response.submittedAt | date:'medium' }}</strong>
            </div>
          </div>
          <div class="view-row">
            <span>Note</span>
            <strong>{{ response.note || '—' }}</strong>
          </div>
        </article>
      </div>
      <ng-template #emptyResponses>
        <div class="empty">No submitted negative responses for this audit yet.</div>
      </ng-template>
      <footer>
        <button class="primary" type="button" (click)="closeView()">Done</button>
      </footer>
    </div>
  </div>
</section>
